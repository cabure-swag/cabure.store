export default async function handler(req,res){try{if(req.method!=='POST')return res.status(405).json({error:'Method not allowed'});const {orderId,brandSlug,items}=req.body||{};if(!orderId||!brandSlug||!Array.isArray(items))return res.status(400).json({error:'Bad request'});const { createClient }=await import('@supabase/supabase-js');const supa=createClient(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY);const {data:brand,error}=await supa.from('brands').select('mp_access_token').eq('slug',brandSlug).single();if(error)return res.status(500).json({error:error.message});if(!brand?.mp_access_token)return res.status(400).json({error:'Admin debe configurar MP para esta marca'});const accessToken=brand.mp_access_token;const pref={items:items.map(it=>({title:it.title,quantity:it.quantity,unit_price:it.unit_price,currency_id:'ARS'})),back_urls:{success:`${req.headers.origin}/compras`,failure:`${req.headers.origin}/pedido/${brandSlug}?estado=failure`,pending:`${req.headers.origin}/compras?estado=pending`},auto_return:'approved',metadata:{orderId,brandSlug}};const mpRes=await fetch('https://api.mercadopago.com/checkout/preferences',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${accessToken}`},body:JSON.stringify(pref)});const data=await mpRes.json();if(!mpRes.ok)return res.status(mpRes.status).json({error:data?.message||'MP error',details:data});return res.status(200).json({id:data.id,init_point:data.init_point})}catch(e){return res.status(500).json({error:e.message})}}
